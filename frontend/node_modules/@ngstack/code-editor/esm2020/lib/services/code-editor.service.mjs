import { Injectable, InjectionToken, Optional, Inject } from '@angular/core';
import { Subject, BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
export const EDITOR_SETTINGS = new InjectionToken('EDITOR_SETTINGS');
export class CodeEditorService {
    constructor(settings) {
        // baseUrl = 'assets/monaco';
        this.baseUrl = 'https://unpkg.com/monaco-editor/min';
        // typingsWorkerUrl = 'assets/workers/typings-worker.js';
        this.typingsWorkerUrl = 'https://unpkg.com/@ngstack/code-editor/workers/typings-worker.js';
        this.typingsLoaded = new Subject();
        this.loaded = new Subject();
        this.loadingTypings = new BehaviorSubject(false);
        const defaults = {
            baseUrl: this.baseUrl,
            typingsWorkerUrl: this.typingsWorkerUrl,
            ...settings,
        };
        this.baseUrl = defaults.baseUrl;
        this.typingsWorkerUrl = defaults.typingsWorkerUrl;
    }
    loadTypingsWorker() {
        if (!this.typingsWorker && window.Worker) {
            if (this.typingsWorkerUrl.startsWith('http')) {
                const proxyScript = `importScripts('${this.typingsWorkerUrl}');`;
                const proxy = URL.createObjectURL(new Blob([proxyScript], { type: 'text/javascript' }));
                this.typingsWorker = new Worker(proxy);
            }
            else {
                this.typingsWorker = new Worker(this.typingsWorkerUrl);
            }
            this.typingsWorker.addEventListener('message', (e) => {
                this.loadingTypings.next(false);
                this.typingsLoaded.next(e.data);
            });
        }
        return this.typingsWorker;
    }
    loadTypings(dependencies) {
        if (dependencies && dependencies.length > 0) {
            const worker = this.loadTypingsWorker();
            if (worker) {
                this.loadingTypings.next(true);
                worker.postMessage({
                    dependencies,
                });
            }
        }
    }
    loadEditor() {
        return new Promise((resolve) => {
            const onGotAmdLoader = () => {
                window.require.config({
                    paths: { vs: `${this.baseUrl}/vs` },
                });
                if (this.baseUrl.startsWith('http')) {
                    const proxyScript = `
            self.MonacoEnvironment = {
              baseUrl: "${this.baseUrl}"
            };
            importScripts('${this.baseUrl}/vs/base/worker/workerMain.js');
          `;
                    const proxy = URL.createObjectURL(new Blob([proxyScript], { type: 'text/javascript' }));
                    window['MonacoEnvironment'] = {
                        getWorkerUrl: function () {
                            return proxy;
                        },
                    };
                }
                window.require(['vs/editor/editor.main'], () => {
                    this.loaded.next({ monaco });
                    resolve();
                });
            };
            if (!window.require) {
                const loaderScript = document.createElement('script');
                loaderScript.type = 'text/javascript';
                loaderScript.src = `${this.baseUrl}/vs/loader.js`;
                loaderScript.addEventListener('load', onGotAmdLoader);
                document.body.appendChild(loaderScript);
            }
            else {
                onGotAmdLoader();
            }
        });
    }
}
CodeEditorService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.1", ngImport: i0, type: CodeEditorService, deps: [{ token: EDITOR_SETTINGS, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
CodeEditorService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.1", ngImport: i0, type: CodeEditorService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.1", ngImport: i0, type: CodeEditorService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [EDITOR_SETTINGS]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1lZGl0b3Iuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvZGUtZWRpdG9yL3NyYy9saWIvc2VydmljZXMvY29kZS1lZGl0b3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDOztBQUtoRCxNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsSUFBSSxjQUFjLENBQy9DLGlCQUFpQixDQUNsQixDQUFDO0FBZUYsTUFBTSxPQUFPLGlCQUFpQjtJQWU1QixZQUdFLFFBQTRCO1FBakI5Qiw2QkFBNkI7UUFDN0IsWUFBTyxHQUFHLHFDQUFxQyxDQUFDO1FBRWhELHlEQUF5RDtRQUN6RCxxQkFBZ0IsR0FDZCxrRUFBa0UsQ0FBQztRQUVyRSxrQkFBYSxHQUFHLElBQUksT0FBTyxFQUFlLENBQUM7UUFDM0MsV0FBTSxHQUFHLElBQUksT0FBTyxFQUFtQixDQUFDO1FBRXhDLG1CQUFjLEdBQUcsSUFBSSxlQUFlLENBQVUsS0FBSyxDQUFDLENBQUM7UUFTbkQsTUFBTSxRQUFRLEdBQUc7WUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87WUFDckIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLGdCQUFnQjtZQUN2QyxHQUFHLFFBQVE7U0FDWixDQUFDO1FBRUYsSUFBSSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsZ0JBQWdCLENBQUM7SUFDcEQsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBVSxNQUFPLENBQUMsTUFBTSxFQUFFO1lBQy9DLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDNUMsTUFBTSxXQUFXLEdBQUcsa0JBQWtCLElBQUksQ0FBQyxnQkFBZ0IsS0FBSyxDQUFDO2dCQUNqRSxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsZUFBZSxDQUMvQixJQUFJLElBQUksQ0FBQyxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUMsQ0FDckQsQ0FBQztnQkFDRixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3hDO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7YUFDeEQ7WUFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFO2dCQUNuRCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xDLENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7SUFDNUIsQ0FBQztJQUVELFdBQVcsQ0FBQyxZQUFzQjtRQUNoQyxJQUFJLFlBQVksSUFBSSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMzQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUN4QyxJQUFJLE1BQU0sRUFBRTtnQkFDVixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0IsTUFBTSxDQUFDLFdBQVcsQ0FBQztvQkFDakIsWUFBWTtpQkFDYixDQUFDLENBQUM7YUFDSjtTQUNGO0lBQ0gsQ0FBQztJQUVELFVBQVU7UUFDUixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDN0IsTUFBTSxjQUFjLEdBQUcsR0FBRyxFQUFFO2dCQUNwQixNQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztvQkFDM0IsS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sS0FBSyxFQUFFO2lCQUNwQyxDQUFDLENBQUM7Z0JBRUgsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsRUFBRTtvQkFDbkMsTUFBTSxXQUFXLEdBQUc7OzBCQUVKLElBQUksQ0FBQyxPQUFPOzs2QkFFVCxJQUFJLENBQUMsT0FBTztXQUM5QixDQUFDO29CQUNGLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxlQUFlLENBQy9CLElBQUksSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyxDQUNyRCxDQUFDO29CQUNGLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxHQUFHO3dCQUM1QixZQUFZLEVBQUU7NEJBQ1osT0FBTyxLQUFLLENBQUM7d0JBQ2YsQ0FBQztxQkFDRixDQUFDO2lCQUNIO2dCQUVLLE1BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLEdBQUcsRUFBRTtvQkFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO29CQUM3QixPQUFPLEVBQUUsQ0FBQztnQkFDWixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQztZQUVGLElBQUksQ0FBTyxNQUFPLENBQUMsT0FBTyxFQUFFO2dCQUMxQixNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN0RCxZQUFZLENBQUMsSUFBSSxHQUFHLGlCQUFpQixDQUFDO2dCQUN0QyxZQUFZLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sZUFBZSxDQUFDO2dCQUNsRCxZQUFZLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLGNBQWMsQ0FBQyxDQUFDO2dCQUN0RCxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUN6QztpQkFBTTtnQkFDTCxjQUFjLEVBQUUsQ0FBQzthQUNsQjtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7OEdBckdVLGlCQUFpQixrQkFpQmxCLGVBQWU7a0hBakJkLGlCQUFpQixjQUZoQixNQUFNOzJGQUVQLGlCQUFpQjtrQkFIN0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQWlCSSxRQUFROzswQkFDUixNQUFNOzJCQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3ViamVjdCwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb2RlRWRpdG9yU2V0dGluZ3MgfSBmcm9tICcuLi9lZGl0b3Itc2V0dGluZ3MnO1xuXG5kZWNsYXJlIGNvbnN0IG1vbmFjbzogYW55O1xuXG5leHBvcnQgY29uc3QgRURJVE9SX1NFVFRJTkdTID0gbmV3IEluamVjdGlvblRva2VuPENvZGVFZGl0b3JTZXR0aW5ncz4oXG4gICdFRElUT1JfU0VUVElOR1MnXG4pO1xuXG5leHBvcnQgaW50ZXJmYWNlIFR5cGluZ3NJbmZvIHtcbiAgZW50cnlQb2ludHM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH07XG4gIGZpbGVzOiBBcnJheTx7XG4gICAgY29udGVudDogc3RyaW5nO1xuICAgIG5hbWU6IHN0cmluZztcbiAgICB1cmw6IHN0cmluZztcbiAgICBwYXRoOiBzdHJpbmc7XG4gIH0+O1xufVxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgQ29kZUVkaXRvclNlcnZpY2Uge1xuICAvLyBiYXNlVXJsID0gJ2Fzc2V0cy9tb25hY28nO1xuICBiYXNlVXJsID0gJ2h0dHBzOi8vdW5wa2cuY29tL21vbmFjby1lZGl0b3IvbWluJztcblxuICAvLyB0eXBpbmdzV29ya2VyVXJsID0gJ2Fzc2V0cy93b3JrZXJzL3R5cGluZ3Mtd29ya2VyLmpzJztcbiAgdHlwaW5nc1dvcmtlclVybCA9XG4gICAgJ2h0dHBzOi8vdW5wa2cuY29tL0BuZ3N0YWNrL2NvZGUtZWRpdG9yL3dvcmtlcnMvdHlwaW5ncy13b3JrZXIuanMnO1xuXG4gIHR5cGluZ3NMb2FkZWQgPSBuZXcgU3ViamVjdDxUeXBpbmdzSW5mbz4oKTtcbiAgbG9hZGVkID0gbmV3IFN1YmplY3Q8eyBtb25hY286IGFueSB9PigpO1xuXG4gIGxvYWRpbmdUeXBpbmdzID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSk7XG5cbiAgcHJpdmF0ZSB0eXBpbmdzV29ya2VyOiBXb3JrZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KEVESVRPUl9TRVRUSU5HUylcbiAgICBzZXR0aW5nczogQ29kZUVkaXRvclNldHRpbmdzXG4gICkge1xuICAgIGNvbnN0IGRlZmF1bHRzID0ge1xuICAgICAgYmFzZVVybDogdGhpcy5iYXNlVXJsLFxuICAgICAgdHlwaW5nc1dvcmtlclVybDogdGhpcy50eXBpbmdzV29ya2VyVXJsLFxuICAgICAgLi4uc2V0dGluZ3MsXG4gICAgfTtcblxuICAgIHRoaXMuYmFzZVVybCA9IGRlZmF1bHRzLmJhc2VVcmw7XG4gICAgdGhpcy50eXBpbmdzV29ya2VyVXJsID0gZGVmYXVsdHMudHlwaW5nc1dvcmtlclVybDtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFR5cGluZ3NXb3JrZXIoKTogV29ya2VyIHtcbiAgICBpZiAoIXRoaXMudHlwaW5nc1dvcmtlciAmJiAoPGFueT53aW5kb3cpLldvcmtlcikge1xuICAgICAgaWYgKHRoaXMudHlwaW5nc1dvcmtlclVybC5zdGFydHNXaXRoKCdodHRwJykpIHtcbiAgICAgICAgY29uc3QgcHJveHlTY3JpcHQgPSBgaW1wb3J0U2NyaXB0cygnJHt0aGlzLnR5cGluZ3NXb3JrZXJVcmx9Jyk7YDtcbiAgICAgICAgY29uc3QgcHJveHkgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKFxuICAgICAgICAgIG5ldyBCbG9iKFtwcm94eVNjcmlwdF0sIHsgdHlwZTogJ3RleHQvamF2YXNjcmlwdCcgfSlcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy50eXBpbmdzV29ya2VyID0gbmV3IFdvcmtlcihwcm94eSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnR5cGluZ3NXb3JrZXIgPSBuZXcgV29ya2VyKHRoaXMudHlwaW5nc1dvcmtlclVybCk7XG4gICAgICB9XG4gICAgICB0aGlzLnR5cGluZ3NXb3JrZXIuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChlKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1R5cGluZ3MubmV4dChmYWxzZSk7XG4gICAgICAgIHRoaXMudHlwaW5nc0xvYWRlZC5uZXh0KGUuZGF0YSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudHlwaW5nc1dvcmtlcjtcbiAgfVxuXG4gIGxvYWRUeXBpbmdzKGRlcGVuZGVuY2llczogc3RyaW5nW10pIHtcbiAgICBpZiAoZGVwZW5kZW5jaWVzICYmIGRlcGVuZGVuY2llcy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB3b3JrZXIgPSB0aGlzLmxvYWRUeXBpbmdzV29ya2VyKCk7XG4gICAgICBpZiAod29ya2VyKSB7XG4gICAgICAgIHRoaXMubG9hZGluZ1R5cGluZ3MubmV4dCh0cnVlKTtcbiAgICAgICAgd29ya2VyLnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICBkZXBlbmRlbmNpZXMsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGxvYWRFZGl0b3IoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBjb25zdCBvbkdvdEFtZExvYWRlciA9ICgpID0+IHtcbiAgICAgICAgKDxhbnk+d2luZG93KS5yZXF1aXJlLmNvbmZpZyh7XG4gICAgICAgICAgcGF0aHM6IHsgdnM6IGAke3RoaXMuYmFzZVVybH0vdnNgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICh0aGlzLmJhc2VVcmwuc3RhcnRzV2l0aCgnaHR0cCcpKSB7XG4gICAgICAgICAgY29uc3QgcHJveHlTY3JpcHQgPSBgXG4gICAgICAgICAgICBzZWxmLk1vbmFjb0Vudmlyb25tZW50ID0ge1xuICAgICAgICAgICAgICBiYXNlVXJsOiBcIiR7dGhpcy5iYXNlVXJsfVwiXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaW1wb3J0U2NyaXB0cygnJHt0aGlzLmJhc2VVcmx9L3ZzL2Jhc2Uvd29ya2VyL3dvcmtlck1haW4uanMnKTtcbiAgICAgICAgICBgO1xuICAgICAgICAgIGNvbnN0IHByb3h5ID0gVVJMLmNyZWF0ZU9iamVjdFVSTChcbiAgICAgICAgICAgIG5ldyBCbG9iKFtwcm94eVNjcmlwdF0sIHsgdHlwZTogJ3RleHQvamF2YXNjcmlwdCcgfSlcbiAgICAgICAgICApO1xuICAgICAgICAgIHdpbmRvd1snTW9uYWNvRW52aXJvbm1lbnQnXSA9IHtcbiAgICAgICAgICAgIGdldFdvcmtlclVybDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICByZXR1cm4gcHJveHk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICAoPGFueT53aW5kb3cpLnJlcXVpcmUoWyd2cy9lZGl0b3IvZWRpdG9yLm1haW4nXSwgKCkgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGVkLm5leHQoeyBtb25hY28gfSk7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH07XG5cbiAgICAgIGlmICghKDxhbnk+d2luZG93KS5yZXF1aXJlKSB7XG4gICAgICAgIGNvbnN0IGxvYWRlclNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgICAgICBsb2FkZXJTY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnO1xuICAgICAgICBsb2FkZXJTY3JpcHQuc3JjID0gYCR7dGhpcy5iYXNlVXJsfS92cy9sb2FkZXIuanNgO1xuICAgICAgICBsb2FkZXJTY3JpcHQuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIG9uR290QW1kTG9hZGVyKTtcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsb2FkZXJTY3JpcHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb25Hb3RBbWRMb2FkZXIoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuIl19